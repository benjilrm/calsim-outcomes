
Refer to [project overview](https://docs.google.com/document/d/1QPh7cKy7fmokalWuou5Z_zqG6680rybq8CC6gmiC8RE/edit?tab=t.0) document for guidance


# Set up

Import packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
  library(tidyverse)   # Data wrangling
  library(here)        # File management
  library(readxl)      # Read excel files
  })})
```

Set settings and universal variables
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here())
options(scipen = 999)
```


# Import data

```{r}
folder_path <- "Outputs/Annual demand met/"  
csv_files <- list.files(path = folder_path, pattern = "\\.csv$", full.names = T)

combined_df <- do.call(rbind, lapply(csv_files, read_csv))
```
# Plots

```{r}
read.csv("Outputs/Tier summaries/all_scenarios_tier_matrix.csv")%>%
  pivot_longer(-scenario_id, names_to = "du", values_to = "tier")%>%
  filter(!is.na(tier))%>%
  group_by(scenario_id)%>%
  mutate(total_n = n())%>%
  ungroup()%>%
  group_by(scenario_id, tier)%>%
  reframe(prop = n()/total_n)%>%
  unique()%>%
  ggplot(aes(scenario_id, prop, fill = as.factor(tier)))+
  geom_col(position="stack")+
  labs(x= "Scenario", y = "Proportion of Demand Units", fill = "Tier")
```

```{r}
combined_df%>%
  ggplot(aes(percent_demand_met, fill = scenario_id))+
  geom_density(alpha = 0.1, position = "identity") +
  labs(x = "% Annual Demand Met", y = "Density", subtitle = "Across all demand units and all years")

combined_df%>%
  filter(scenario_id == "s0045")%>%
  ggplot(aes(percent_demand_met))+
  geom_histogram(aes(y = ..count../sum(..count..)*100), fill = "coral1", colour = "black")+
  labs(x = "% Annual Demand Met", y = "% of Values (across all demand units and years)", subtitle = "Scenario S0045, across all demand units and years")


library(ggridges)

ggplot(combined_df, aes(x = percent_demand_met, y = scenario_id, fill = scenario_id)) +
  geom_density_ridges(
    aes(height = after_stat(density)),
    stat = "density",
    scale = 0.9,
    alpha = 0.7) +
  scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) +
  theme_ridges() +
  labs(x = "% demand met", y = "Scenario", subtitle = "All years & demand units")+
  theme(legend.position = "none")
```

```{r}
grouped = combined_df %>%
  group_by(scenario_id, dwuc) %>%
  summarise(
    n_years = n(),
    pct_met_100 = mean(percent_demand_met >= 100, na.rm = TRUE) * 100,
    pct_met_90 = mean(percent_demand_met >= 90, na.rm = TRUE) * 100,
    pct_met_75 = mean(percent_demand_met >= 75, na.rm = TRUE) * 100,
    pct_met_50 = mean(percent_demand_met >= 50, na.rm = TRUE) * 100,
    mean_demand_met = mean(percent_demand_met, na.rm = TRUE),
    median_demand_met = median(percent_demand_met, na.rm = TRUE),
    min_demand_met = min(percent_demand_met, na.rm = TRUE),
    max_demand_met = max(percent_demand_met, na.rm = TRUE),
    .groups = 'drop')

ggplot(grouped, aes(x = pct_met_100)) +
  geom_histogram(binwidth = 5, fill = "steelblue", alpha = 0.7)+ 
  geom_vline(xintercept = c(50, 70, 90), linetype = "dashed", size = 1) +
  facet_wrap(~scenario_id, ncol = 4) +
  labs(title = "Distribution of % Years with Full Demand Met, by Demand Unit",
       x = "% Years with 100%+ Demand Met",
       y = "# of Demand Units") +
  theme_bw()


ggplot(grouped, aes(x = min_demand_met)) +
  geom_histogram(binwidth = 5, fill = "coral4", alpha = 0.7)+ 
  geom_vline(xintercept = c(50, 70, 90), linetype = "dashed", size = 1) +
  facet_wrap(~scenario_id, ncol = 4) +
  labs(title = "Distribution of Minimum Demand Met by Demand Unit",
       x = "% Demand Met in Worst Year",
       y = "# of Demand Units") +
  theme_bw()
```





