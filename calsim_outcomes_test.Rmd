Refer to [project overview](https://docs.google.com/document/d/1QPh7cKy7fmokalWuou5Z_zqG6680rybq8CC6gmiC8RE/edit?tab=t.0) document for guidance


# Set up

Import packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
  library(tidyverse)   # Data wrangling
  library(here)        # File management
  library(readxl)      # Read excel files
  })})
```

Set settings and universal variables
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here())
options(scipen = 999)

dus_of_interest = c("MWD", "PLMAS", "CSB103", "02_SU", "26N_NU3")
```

# Import and process data

## Crosswalk
Crosswalk between demand units' demand ID and delivery ID
Provided by Kristin via [this folder](https://drive.google.com/drive/folders/1BYFQlIA0JJ31sAHDt7yMovLWWZvwoMeO)
```{r}
crosswalk = read_excel("Inputs/Master crosswalk SW DUs M&I.xlsx")%>%
  rename(dwuc = 1, demand_id = 2, delivery_id = 3)
```

Demand and delivery data downloaded from the respective Google Drive folder linked to each scenario in [this spreadsheet](https://docs.google.com/spreadsheets/d/1iXqEc4sMVC8gKqPzhf_VOS32EXKzocAP2pNJ5PZlFbY/edit?gid=0#gid=0). Once in a scenario's folder, click on 'Data Extraction', then 'Demands_Deliveries'. We want to download csvs of monthly values for both demand and deliveries.


## Monthly demand data

Need to standardise units and join to crosswalk to get demand unit ID
```{r}
raw = read.csv("Inputs/Demands/s0045_DCRadjBL_2020LU_RelaxFallX2_DEMANDS.csv")

processed_wide = raw%>%
  mutate(row_id = row_number())%>%
  pivot_longer(cols = -row_id,
               names_to = "col_position",
               values_to = "value")%>%
  pivot_wider(
    names_from = row_id,
    values_from = value)%>%
  rename(
    col_position = 1,
    demand_id = 2,    
    units = 7)

dates = processed_wide %>%
  slice(1) %>%
  select(8:ncol(.)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "date_id",
    values_to = "date")

demand_processed = processed_wide%>%
  filter(units == "TAF" & demand_id %in% crosswalk$demand_id)%>%
  select(-c(1,3:units))%>%
  pivot_longer(
    cols = -demand_id,
    names_to = "date_id",
    values_to = "demand_taf")%>%
  mutate(demand_taf = as.numeric(ifelse(demand_taf == "", NA, demand_taf)))%>%
  left_join(., dates, by = "date_id")%>%
  select(-date_id)%>%
  left_join(., crosswalk %>% select(-delivery_id), by = "demand_id")
```

```{r}
  # Create list of missing units
  not_present = crosswalk %>%
    select(dwuc, demand_id)%>%
    mutate(
      demand_status = ifelse(!demand_id %in% demand_processed$demand_id, "Not in data", NA)) %>%
    filter(!is.na(demand_status))
  
  # Check if all values for demand_taf are either 0 or NA
  all_blank_or_all_zero = demand_processed%>%
    group_by(dwuc, demand_id)%>%
    reframe(
      demand_status = case_when(
        all(is.na(demand_taf)) ~ "All blank", 
        all(demand_taf == 0) ~ "All zero",
        T ~ NA))%>%
    ungroup()%>%
    filter(!is.na(demand_status))
  
  missing = rbind(not_present, all_blank_or_all_zero)
  missing
```


## Deliveries

Need to standardise units and join to crosswalk to get demand unit ID
```{r}
raw = read.csv("Inputs/Deliveries/s0045_DCRadjBL_2020LU_RelaxFallX2_DELIVERIES.csv")

processed_wide = raw%>%
  mutate(row_id = row_number())%>%
  pivot_longer(cols = -row_id,
               names_to = "col_position",
               values_to = "value")%>%
  pivot_wider(
    names_from = row_id,
    values_from = value)%>%
  rename(
    col_position = 1,
    delivery_id = 2,    
    units = 7)

dates = processed_wide %>%
  slice(1) %>%  # Get the row with dates
  select(8:ncol(.)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "date_id",
    values_to = "date")

delivery_processed = processed_wide%>%
  filter(units == "TAF" & delivery_id %in% crosswalk$delivery_id)%>%
  select(-c(1,3:units))%>%
  pivot_longer(
    cols = -delivery_id,
    names_to = "date_id",
    values_to = "delivery_taf")%>%
  mutate(delivery_taf = as.numeric(ifelse(delivery_taf == "", NA, delivery_taf)))%>%
  left_join(., dates, by = "date_id")%>%
  left_join(crosswalk %>% select(-demand_id), by = "delivery_id")
```

```{r}
combined = full_join(delivery_processed, demand_processed, by = c("dwuc", "date"))
  mutate(delivery_taf = as.numeric(ifelse(delivery_taf == "", NA, delivery_taf)),
         demand_taf = as.numeric(ifelse(demand_taf == "", NA, demand_taf)))%>%
  mutate(percent_demand_met = ifelse(delivery_taf >= demand_taf, 100, delivery_taf / demand_taf * 100),
         year = year(date))%>%
  select(dwuc, delivery_id, demand_id, year, date, delivery_taf, demand_taf, percent_demand_met)

combined%>%
  #filter(is.na(percent_demand_met))%>%
  filter(dwuc == "02_SU" & (demand_taf == 0 | is.na(demand_taf) | delivery_taf == 0 | is.na(delivery_taf)))
  filter(dwuc %in% dus_of_interest)
  
read.csv("Outputs/Annual demand met/s0044_demand_met_by_year.csv")%>%
  filter(dwuc == "26N_NU3")%>%
  mutate(demand_met = ifelse(percent_demand_met >= 100, 1, 0))
    group_by(scenario_id, dwuc) %>%
    reframe(
      perc_years_met = sum(demand_met) / n() * 100,
      min_met = min(percent_demand_met)) %>%
    ungroup() %>%
    mutate(
      tier = case_when(
        perc_years_met >= 90 & min_met > 75 ~ 1,
        perc_years_met >= 70 & min_met > 75 ~ 2,
        perc_years_met >= 50 & min_met > 50 ~ 3,
        T ~ 4)) %>%
    select(scenario_id, dwuc, tier)
```

# Analysis

## Missingness

Create list of demand units that are entirely missing either delivery or demand values.
```{r}
missing = crosswalk%>%
  mutate(demand_missing = ifelse(!demand_id %in% demand_processed$demand_id, 1, 0),
         delivery_missing = ifelse(!delivery_id %in% delivery_processed$delivery_id, 1, 0))%>%
  filter(delivery_missing == 1 | demand_missing == 1)
```

Investigate month to month missingness for demand & delivery values
```{r}
combined%>%
  mutate(delivery_id_missing = ifelse(is.na(delivery_id), 1, 0),
         delivery_taf_missing = ifelse(is.na(delivery_taf), 1, 0),
         demand_id_missing = ifelse(is.na(demand_id), 1, 0),
         demand_taf_missing = ifelse(is.na(demand_id), 1, 0))%>%
  group_by(dwuc, year)%>%
  reframe(delivery_id_missing = sum(delivery_id_missing),
          delivery_taf_missing = sum(delivery_taf_missing),
          demand_id_missing = sum(demand_id_missing),
          demand_taf_missing = sum(demand_taf_missing))%>%
  filter(delivery_taf_missing > 0 | demand_taf_missing > 0)%>%
  filter(!dwuc %in% missing$dwuc)

combined%>%
  filter(!dwuc %in% missing$dwuc)%>%
  mutate(missing = ifelse(is.na(delivery_taf) | is.na(demand_taf), 1, 0))%>%
  group_by(year, dwuc)%>%
  reframe(annual_delivery = sum(delivery_taf),
          annual_demand = sum(demand_taf),
          n_missing_months = sum(missing))%>%
  ungroup()%>%
  mutate(totally_missing = ifelse(n_missing_months == 12, 1, 0),
         partially_missing = ifelse(n_missing_months > 0, 1, 0))%>%
  group_by(dwuc)%>%
  reframe(years_totally_missing = sum(totally_missing),
          years_partially_missing = sum(partially_missing))%>%
  arrange(-years_totally_missing, -years_partially_missing)
```

Exclude any demand units that are entirely missing demand or delivery values. That way, we avoid scenarios where demand has a value and delivery is missing, which could incorrectly throw a 0% met when that's not necessarily true. 
Similarly, exclude any months for demand units where either demand or delivery is NA.
```{r}
combined = combined%>%
  filter(!dwuc %in% missing$dwuc)
  mutate(missing = ifelse(is.na(delivery_taf) | is.na(demand_taf), 1, 0))%>%
  filter(missing == 0)
  
n_distinct(combined$dwuc)
```


## Percent demand met and tiers

Aggregate delivery and demand by year, then calculate % of demand met by year. 

Based on that, calculate % of years where demand is fully met and the minimum % of demand met in deficit years.
From there, we can assign tiers according to the criteria we've listed in [this spreadsheet](https://docs.google.com/spreadsheets/d/1xcQIR_J96-cs7BuCrXjznwkinLgxl-Pf9tA3mJ2GiyA/edit?gid=916228682#gid=916228682)
```{r}
combined_by_year = combined%>%
  group_by(year, dwuc)%>%
  reframe(annual_delivery = sum(delivery_taf),
          annual_demand = sum(demand_taf))%>%
  ungroup()%>%
  mutate(percent_demand_met = ifelse(annual_delivery >= annual_demand, 100, annual_delivery / annual_demand * 100))

#write.csv(combined_by_year, "Outputs/insert scenario id here_demand_met_by_year.csv", row.names = F)

tiers = combined_by_year%>%
  mutate(demand_met = ifelse(percent_demand_met >= 100, 1, 0))%>%
  group_by(dwuc)%>%
  reframe(perc_years_met = sum(demand_met)/n()*100,
          min_met = min(percent_demand_met))%>%
  ungroup()%>%
    mutate(tier = case_when(
    perc_years_met >= 90 & min_met > 75 ~ 1,
    perc_years_met >= 70 & min_met > 75 ~ 2,
    perc_years_met >= 50 & min_met > 50 ~ 3,
    T ~ 4))
```


```{r}
read.csv("Outputs/Annual demand met/s0010_demand_met_by_year.csv")%>%
  filter(dwuc == "02_PU")

read.csv("Outputs/Monthly demand met/s0010_demand_met_by_month.csv")%>%
  filter(dwuc == "02_PU" & year == 1921)
  summarise(sum = sum(delivery_taf))

read.csv("Inputs/Deliveries/s0010_draftDCP_NDD_SWP6000_Beth_2020_DELIVERIES.csv", skip = 1)%>%
  select(contains("DN_02_PU"))
  filter( year == 1921)%>%
  summarise(sum = sum(delivery_taf))
```

```{r}
read.csv("C:/Users/benji/Downloads/s0010_draftDCP_NDD_SWP6000_Beth_2020_DELIVERIES-ANNUAL.csv", skip = 1)
```


Missingness
```{r}
read.csv("Outputs/Missing demand units/s0045_missing_dus.csv")
  reframe(dem = sum(demand_missing), del = sum(delivery_missing))

read.csv("Inputs/Deliveries/s0010_draftDCP_NDD_SWP6000_Beth_2020_DELIVERIES.csv", skip = 1)%>%
  select(contains("D_CLRLK_CLLPT"))
read.csv("Inputs/Demands/s0010_draftDCP_NDD_SWP6000_Beth_2020_DEMANDS.csv", skip = 1)%>%
  select(contains("U_CLPT"))

read.csv("Outputs/Monthly demand met/s0010_demand_met_by_month.csv")%>%
  filter(demand_taf == 0 | delivery_taf == 0)
```

```{r}
read.csv("Outputs/Missing demand units/all_scenarios_missing_dus.csv")
```

